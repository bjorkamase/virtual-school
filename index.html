<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Misteri Sekolah - Akses Semua Lantai</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
    <style>
      html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; position: fixed; font-family: sans-serif; }
      #ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center; color: white; text-align: center; }
      #mission-box { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.8); color: #0f0; padding: 10px; border: 1px solid #0f0; font-size: 12px; z-index: 500; border-radius: 5px; }
      #chat-area { position: absolute; bottom: 15px; left: 10px; right: 10px; z-index: 1000; }
      #messages { height: 80px; background: rgba(0,0,0,0.7); color: #fff; padding: 8px; overflow-y: auto; font-size: 11px; margin-bottom: 5px; }
      .input-row { display: flex; }
      #chat-input { flex: 1; padding: 12px; border: none; border-radius: 5px 0 0 5px; font-size: 16px; }
      #send-btn { padding: 0 15px; background: #27ae60; color: white; border: none; border-radius: 0 5px 5px 0; }
    </style>
  </head>
  <body>

    <div id="mission-box">MISI: Injak LIFT (Kuning) untuk naik lantai!<br>Injak pintu hijau untuk masuk kelas.</div>

    <div id="ui-overlay">
      <div style="background: #222; padding: 20px; border-radius: 15px; width: 80%;">
        <h2 style="color: #0f0;">GEDUNG 4 LANTAI</h2>
        <p>Gunakan Lingkaran Kuning di ujung koridor untuk naik/turun lantai.</p>
        <button style="padding: 15px 30px; background: #27ae60; color: white; border: none; border-radius: 10px; font-weight: bold;" onclick="mulai()">MENGERTI</button>
      </div>
    </div>

    <div id="chat-area" style="display:none;">
      <div id="messages"></div>
      <div class="input-row">
        <input type="text" id="chat-input" placeholder="Ketik /jawab 482">
        <button id="send-btn" onclick="kirim()">Kirim</button>
      </div>
    </div>

    <a-scene shadow="type: pcfsoft">
      <a-entity environment="preset: goldmine; lighting: point; groundColor: #222; dressingAmount: 5;"></a-entity>
      <a-light type="ambient" intensity="0.7"></a-light>

      <a-entity id="school-building"></a-entity>

      <a-entity id="interior" visible="false" position="0 -50 0">
        <a-box width="10" height="4" depth="10" color="#333" side="double"></a-box>
        <a-box position="0 2 -4.9" width="5" height="2" color="#111"></a-box>
        <a-text id="board-text" value="KOSONG" position="0 2 -4.8" align="center" width="5" color="#0f0"></a-text>
        <a-circle position="0 0.1 4" radius="1" color="red" opacity="0.6" rotation="-90 0 0"></a-circle>
        <a-text value="BERDIRI DI SINI UNTUK KELUAR" position="0 2 3.5" align="center" width="4"></a-text>
      </a-entity>

      <a-entity id="rig" position="0 1.6 15">
        <a-camera look-controls="touchEnabled: true" wasd-controls="acceleration: 100"></a-camera>
      </a-entity>
    </a-scene>

    <script>
      const rig = document.getElementById('rig');
      const school = document.getElementById('school-building');
      const interior = document.getElementById('interior');
      let lastWorldPos = {x: 0, y: 1.6, z: 15};
      let inClass = false;

      // 1. Buat Gedung & Lift
      for (let l = 0; l < 4; l++) {
        let yBase = l * 4;
        
        // Buat Lantai/Koridor
        let floor = document.createElement('a-plane');
        floor.setAttribute('position', `0 ${yBase} 0`);
        floor.setAttribute('rotation', '-90 0 0');
        floor.setAttribute('width', '40');
        floor.setAttribute('height', '10');
        floor.setAttribute('color', '#444');
        school.appendChild(floor);

        // Buat Lift (Lingkaran Kuning) di ujung kanan koridor
        let lift = document.createElement('a-circle');
        lift.setAttribute('position', `18 ${yBase + 0.1} 3`);
        lift.setAttribute('rotation', '-90 0 0');
        lift.setAttribute('color', 'yellow');
        lift.setAttribute('radius', '1.5');
        lift.setAttribute('opacity', '0.7');
        school.appendChild(lift);

        let liftTurun = document.createElement('a-circle');
        liftTurun.setAttribute('position', `-18 ${yBase + 0.1} 3`);
        liftTurun.setAttribute('rotation', '-90 0 0');
        liftTurun.setAttribute('color', 'orange');
        liftTurun.setAttribute('radius', '1.5');
        liftTurun.setAttribute('opacity', '0.7');
        school.appendChild(liftTurun);

        // Buat 6 Kelas per Lantai
        for (let k = 0; k < 6; k++) {
          let x = (k * 6) - 15;
          let room = document.createElement('a-entity');
          room.setAttribute('position', `${x} ${yBase} -3`);
          room.innerHTML = `
            <a-box width="5.5" height="4" depth="6" color="#555"></a-box>
            <a-box id="door-${l+1}-${k+1}" position="0 0.5 3.1" width="1.5" height="2.5" color="#2ecc71" opacity="0.6"></a-box>
            <a-text value="KELAS ${l+1}0${k+1}" position="0 2.8 3.2" align="center" width="5"></a-text>
          `;
          school.appendChild(room);
        }
      }

      // 2. Sistem Sensor (Deteksi Posisi)
      setInterval(() => {
        let p = rig.getAttribute('position');

        if (inClass) {
          // Sensor Keluar di Interior
          if (p.y < -40 && Math.sqrt(p.x*p.x + (p.z-4)*(p.z-4)) < 1.5) keluar();
          return;
        }

        // Sensor Naik (Kuning) - Pindah ke lantai di atasnya
        if (Math.sqrt(Math.pow(p.x - 18, 2) + Math.pow(p.z - 3, 2)) < 1.5) {
            rig.setAttribute('position', {x: 15, y: p.y + 4, z: 3});
            addMsg("SISTEM", "Naik ke Lantai Atas");
        }

        // Sensor Turun (Oranye)
        if (Math.sqrt(Math.pow(p.x + 18, 2) + Math.pow(p.z - 3, 2)) < 1.5 && p.y > 2) {
            rig.setAttribute('position', {x: -15, y: p.y - 4, z: 3});
            addMsg("SISTEM", "Turun ke Lantai Bawah");
        }

        // Sensor Masuk Kelas (Pintu Hijau)
        for (let l = 1; l <= 4; l++) {
          for (let k = 1; k <= 6; k++) {
            let dx = (k * 6) - 15; let dy = (l - 1) * 4; let dz = 0.1;
            let dist = Math.sqrt(Math.pow(p.x - dx, 2) + Math.pow(p.y - (dy+1.6), 2) + Math.pow(p.z - dz, 2));
            if (dist < 1.2) masuk(l, k);
          }
        }
      }, 300);

      function masuk(l, k) {
        inClass = true;
        lastWorldPos = {...rig.getAttribute('position')};
        let info = "KOSONG";
        if(l==1 && k==2) info = "ANGKA PERTAMA: 4";
        if(l==2 && k==4) info = "ANGKA KEDUA: 8";
        if(l==3 && k==1) info = "ANGKA KETIGA: 2";

        document.getElementById('board-text').setAttribute('value', info);
        interior.setAttribute('visible', 'true');
        school.setAttribute('visible', 'false');
        rig.setAttribute('position', '0 -48.4 0');
      }

      function keluar() {
        inClass = false;
        interior.setAttribute('visible', 'false');
        school.setAttribute('visible', 'true');
        rig.setAttribute('position', {x: lastWorldPos.x, y: lastWorldPos.y, z: lastWorldPos.z + 2});
      }

      function mulai() { document.getElementById('ui-overlay').style.display = 'none'; document.getElementById('chat-area').style.display = 'block'; }
      function kirim() {
        const inp = document.getElementById('chat-input');
        if(inp.value === "/jawab 482") { alert("MENANG!"); location.reload(); }
        else { addMsg("USER", inp.value); inp.value = ""; }
      }
      function addMsg(s, t) {
        const m = document.getElementById('messages');
        m.innerHTML += `<div><b>[${s}]:</b> ${t}</div>`;
        m.scrollTop = m.scrollHeight;
      }
    </script>
  </body>
</html>
